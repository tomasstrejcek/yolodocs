---
phase: 03-sidebar-and-page-rendering
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/site/src/components/markdown/MarkdownPage.tsx
  - src/site/src/routes/docs/[...path].tsx
autonomous: true
requirements: [TITL-03, TITL-04]

must_haves:
  truths:
    - "A markdown page whose content starts with an H1 does NOT render a duplicate heading above the content"
    - "A markdown page whose content has no H1 still renders the title heading above the content"
    - "The browser tab title shows 'Page Title â€” Site Title' format when viewing a doc page"
    - "The browser tab title updates reactively when navigating between doc pages via SPA navigation"
  artifacts:
    - path: "src/site/src/components/markdown/MarkdownPage.tsx"
      provides: "Conditional H1 rendering based on markdown content"
      contains: "Show"
    - path: "src/site/src/routes/docs/[...path].tsx"
      provides: "Per-page browser title via document.title in createEffect"
      contains: "document.title"
  key_links:
    - from: "src/site/src/components/markdown/MarkdownPage.tsx"
      to: "src/markdown/loader.ts"
      via: "Same /^#\\s+/m regex pattern used for H1 detection at scan time and render time"
      pattern: "/\\^#\\\\s\\+/m"
    - from: "src/site/src/routes/docs/[...path].tsx"
      to: "src/site/src/data/site-config.json"
      via: "Imports siteConfig.title for composing browser tab title"
      pattern: "siteConfig"
---

<objective>
Suppress duplicate H1 heading when markdown content already contains one, and set per-page browser tab titles.

Purpose: When a markdown file starts with `# Title`, the current MarkdownPage renders both a heading from `props.title` AND the H1 from the rendered markdown -- creating a duplicate. The fix detects H1 presence and conditionally suppresses the heading element. Additionally, the browser tab title must show the page-specific title (e.g., "Getting Started -- Carl API") instead of the generic site title.

Output: Updated `MarkdownPage.tsx` with conditional H1, updated `[...path].tsx` with reactive `document.title`.
</objective>

<execution_context>
@/Users/tomasstrejcek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomasstrejcek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sidebar-and-page-rendering/03-RESEARCH.md
@.planning/phases/02-flat-html-output/02-02-SUMMARY.md
@src/site/src/components/markdown/MarkdownPage.tsx
@src/site/src/routes/docs/[...path].tsx
@src/site/src/data/site-config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conditional H1 rendering to MarkdownPage</name>
  <files>src/site/src/components/markdown/MarkdownPage.tsx</files>
  <action>
The current `MarkdownPage` component unconditionally renders `<h1 class="text-3xl font-bold text-text-primary mb-6">{props.title}</h1>` above the markdown content. When the markdown itself starts with an H1 heading, this creates a duplicate heading.

**Add `Show` to the import** (line 1):

Current:
```typescript
import { createMemo } from "solid-js";
```

Replace with:
```typescript
import { createMemo, Show } from "solid-js";
```

**Add an H1 detection memo** inside the component, after the `html` memo (after line 24):

```typescript
const hasH1 = createMemo(() => /^#\s+/m.test(props.content));
```

This uses the same regex pattern proven in `extractFirstH1` from Phase 1 (`src/markdown/loader.ts`). The `/m` flag makes `^` match any line start.

**Wrap the `<h1>` element in a `<Show>` guard.** Replace the current JSX return:

Current (lines 26-31):
```typescript
return (
  <div class="max-w-3xl mx-auto px-6 py-8">
    <h1 class="text-3xl font-bold text-text-primary mb-6">{props.title}</h1>
    <div class="markdown-content" innerHTML={html()} />
  </div>
);
```

Replace with:
```typescript
return (
  <div class="max-w-3xl mx-auto px-6 py-8">
    <Show when={!hasH1()}>
      <h1 class="text-3xl font-bold text-text-primary mb-6">{props.title}</h1>
    </Show>
    <div class="markdown-content" innerHTML={html()} />
  </div>
);
```

**Key details:**
- When `props.content` contains an H1, only the markdown-rendered heading appears (styled by the `.markdown-content` CSS).
- When `props.content` does NOT contain an H1 (e.g., a file that starts with text or H2), the component-rendered `<h1>` still appears so the page always has a visible title.
- The regex `/^#\s+/m` matches `# ` at the start of any line. The accepted edge case (H1-like syntax inside code blocks) was reviewed and accepted in Phase 1 research -- it does not occur in practice with author-controlled docs.
  </action>
  <verify>
Visually inspect MarkdownPage.tsx:
1. `Show` is imported from solid-js
2. `hasH1` memo uses `/^#\s+/m` regex on `props.content`
3. `<h1>` element is wrapped in `<Show when={!hasH1()}>`
4. `<div class="markdown-content">` is NOT inside the Show (always renders)
  </verify>
  <done>MarkdownPage conditionally renders the heading. Pages with H1 in markdown content show only the markdown-rendered heading (no duplicate). Pages without H1 still get a title heading.</done>
</task>

<task type="auto">
  <name>Task 2: Add per-page browser tab title to DocsPage</name>
  <files>src/site/src/routes/docs/[...path].tsx</files>
  <action>
Set `document.title` reactively so the browser tab shows the page-specific title (e.g., "Getting Started -- Carl API") instead of the generic site title.

**Add `createEffect` to the import** (line 3 area). Check the current import -- `createMemo` and `createResource` are imported but NOT `createEffect`:

Current:
```typescript
import { Show, createMemo, createResource } from "solid-js";
```

Replace with:
```typescript
import { Show, createMemo, createResource, createEffect } from "solid-js";
```

**Add a siteConfig import** after the existing imports (after line 6):

```typescript
import siteConfig from "../../data/site-config.json";
```

**Add a createEffect** inside the `DocsPage` component body, after the `content` resource declaration (after line 36):

```typescript
createEffect(() => {
  const p = page();
  if (typeof document !== "undefined" && p) {
    document.title = `${p.title} \u2014 ${(siteConfig as any).title}`;
  }
});
```

**Key details:**
- The `typeof document !== "undefined"` guard prevents SSR prerender crashes. While SolidJS `createEffect` does not run during SSR, this provides defense-in-depth.
- The em dash (`\u2014`) separator matches common convention (e.g., "Getting Started -- Carl API").
- `createEffect` is reactive: when the user navigates between doc pages via SPA (without full page reload), `page()` changes and the title updates automatically.
- `siteConfig.title` is the title field from `site-config.json` (set to the CLI's `--title` argument at build time, e.g., "Carl API").
- The `as any` cast on siteConfig is necessary because the JSON import typing is generic.
  </action>
  <verify>
Visually inspect `[...path].tsx`:
1. `createEffect` is imported from solid-js
2. `siteConfig` is imported from `../../data/site-config.json`
3. `createEffect` sets `document.title` from `page().title` and `siteConfig.title`
4. The effect has `typeof document !== "undefined"` guard
5. The separator is an em dash
  </verify>
  <done>DocsPage sets browser tab title to "Page Title -- Site Title" format. Title updates reactively on SPA navigation.</done>
</task>

<task type="auto">
  <name>Task 3: Build and integration test for page rendering changes</name>
  <files></files>
  <action>
Run the build pipeline and integration test to verify all page rendering changes work end-to-end.

```bash
npm run build
rm -rf test-output && node dist/bin/yolodocs.js --schema schema.graphql --output test-output --title "Carl API" --docs-dir ./docs
```

After the integration build completes, verify:

1. **H1 suppression (TITL-03):** Check a doc page that has an H1 in its markdown content. For example, open `test-output/docs/getting-started.html` and search for duplicate headings. The rendered HTML should have only ONE `<h1>` tag from the markdown content, NOT a second one from the component wrapper.

2. **Browser title (TITL-04):** Open the generated HTML and search for `document.title` in the JS bundles, or verify by serving: `npx serve test-output -p 3456` and navigating to a doc page -- the browser tab should show "Getting Started -- Carl API" (or similar).

3. **No build errors, no TypeScript errors.**

Clean up: `rm -rf test-output`
  </action>
  <verify>
1. `npm run build` completes without errors
2. Integration build produces output in test-output/
3. Doc page HTML does not contain duplicate H1 headings
4. No runtime errors in build log
  </verify>
  <done>Build succeeds. Integration test confirms H1 suppression and browser title work correctly. dist/ is up to date.</done>
</task>

</tasks>

<verification>
1. `npm run build` -- TypeScript compiles without errors
2. Integration build (`node dist/bin/yolodocs.js ...`) succeeds
3. `MarkdownPage.tsx` has `<Show when={!hasH1()}>` wrapping the `<h1>` element
4. `MarkdownPage.tsx` has `hasH1` memo using `/^#\s+/m` regex
5. `[...path].tsx` has `createEffect` setting `document.title`
6. `[...path].tsx` imports `siteConfig` from `site-config.json`
7. Doc pages with H1 in markdown do not show duplicate heading
</verification>

<success_criteria>
- MarkdownPage detects H1 in markdown content via regex memo
- MarkdownPage suppresses the component-rendered heading when H1 is present
- MarkdownPage still renders the heading when markdown has no H1
- DocsPage sets document.title reactively using page title + site title
- Browser tab title updates on SPA navigation between doc pages
- Integration build produces correct output
- dist/ is compiled and up to date
</success_criteria>

<output>
After completion, create `.planning/phases/03-sidebar-and-page-rendering/03-02-SUMMARY.md`
</output>
