---
phase: 02-flat-html-output
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/site/app.config.ts
  - src/cli/build.ts
  - src/cli/build.test.ts
autonomous: true
requirements: [HOST-01, HOST-02, HOST-03]

must_haves:
  truths:
    - "All doc anchor URLs in the navigation manifest end with .html"
    - "Nitro prerender config has autoSubfolderIndex set to false"
    - "All existing buildNavigationManifest tests pass with .html-suffixed anchors"
    - "Schema section anchors (hash-based) remain unchanged"
  artifacts:
    - path: "src/site/app.config.ts"
      provides: "Nitro flat prerender configuration"
      contains: "autoSubfolderIndex: false"
    - path: "src/cli/build.ts"
      provides: "Doc anchor URLs with .html extension"
      contains: ".html"
    - path: "src/cli/build.test.ts"
      provides: "Updated anchor assertions with .html"
      contains: ".html"
  key_links:
    - from: "src/cli/build.ts"
      to: "src/site/app.config.ts"
      via: "anchor format matches flat file output naming"
      pattern: "\\.html"
    - from: "src/cli/build.test.ts"
      to: "src/cli/build.ts"
      via: "test assertions verify anchor format"
      pattern: "expect.*\\.html"
---

<objective>
Enable flat HTML file output from Nitro prerender and update all doc anchor URLs in buildNavigationManifest to include the `.html` extension.

Purpose: Static hosting on GCS/S3 requires flat `.html` files (not `slug/index.html` directories) to serve pages without URL rewriting. The manifest anchors must match the actual file paths.

Output: `app.config.ts` with `autoSubfolderIndex: false`, `build.ts` with `.html`-suffixed doc anchors (3 locations), all tests passing.
</objective>

<execution_context>
@/Users/tomasstrejcek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomasstrejcek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-flat-html-output/02-RESEARCH.md
@.planning/phases/01-data-layer/01-02-SUMMARY.md
@src/cli/build.ts
@src/cli/build.test.ts
@src/site/app.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Update anchor assertions to expect .html extension</name>
  <files>src/cli/build.test.ts</files>
  <action>
Update ALL doc anchor assertions in the `buildNavigationManifest` describe block to expect `.html` suffix. The changes are mechanical string appends:

1. Test "produces a 'Documentation' section for root-level pages" (line ~253):
   - `expect(section.items[0].anchor).toBe("/docs/getting-started")` -> `expect(section.items[0].anchor).toBe("/docs/getting-started.html")`

2. Test "creates a group item for 3-level slugs" (line ~308):
   - `expect(group.children![0].anchor).toBe("/docs/product/guides/auth")` -> `expect(group.children![0].anchor).toBe("/docs/product/guides/auth.html")`

3. Test "places ungrouped 2-level pages directly in section" (line ~321):
   - `expect(section.items[0].anchor).toBe("/docs/product/billing")` -> `expect(section.items[0].anchor).toBe("/docs/product/billing.html")`

4. Test "4+ segment slugs" (line ~403):
   - `expect(group.children![0].anchor).toBe("/docs/a/b/c/d")` -> `expect(group.children![0].anchor).toBe("/docs/a/b/c/d.html")`

5. Test "respects base prefix in anchor URLs" (line ~414):
   - `expect(section.items[0].anchor).toBe("/v2/docs/getting-started")` -> `expect(section.items[0].anchor).toBe("/v2/docs/getting-started.html")`

6. Test "full example" (multiple anchors in the expect chain are implicit -- this test checks `.name` not `.anchor`, so no change needed here).

**Do NOT change the group item anchor** (`expect(group.anchor).toBe("")`) -- group folder items have empty anchors and are not navigable.

**Do NOT change schema section anchors** (hash-based like `#query-getUser`) -- those remain unchanged.

After updating, run `npm test` -- tests MUST fail (RED) because production code still emits extensionless anchors.
  </action>
  <verify>Run `npm test` and confirm buildNavigationManifest tests FAIL with assertion errors showing expected `.html` suffix vs actual extensionless anchor. Other tests (toTitleCase, docs content splitting, loader) should still pass.</verify>
  <done>All doc anchor assertions updated to expect `.html` suffix. `npm test` shows failures in buildNavigationManifest tests (RED state confirmed).</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Add .html to doc anchors in buildNavigationManifest + enable flat prerender</name>
  <files>src/cli/build.ts, src/site/app.config.ts</files>
  <action>
**build.ts changes:** Append `.html` to the doc anchor string in THREE locations inside `buildNavigationManifest`:

1. Root section items (line ~302):
   `anchor: \`${base}/docs/${p.slug}\`` -> `anchor: \`${base}/docs/${p.slug}.html\``

2. Section ungrouped items (line ~323):
   `anchor: \`${base}/docs/${p.slug}\`` -> `anchor: \`${base}/docs/${p.slug}.html\``

3. Group child items (line ~339):
   `anchor: \`${base}/docs/${p.slug}\`` -> `anchor: \`${base}/docs/${p.slug}.html\``

**Do NOT change:** Schema section anchors (hash-based `#query-`, `#mutation-`, etc.), group folder anchor (empty string), slugs in docs-manifest.json, or prerenderRoutes entries.

**app.config.ts change:** Add `autoSubfolderIndex: false` to the `prerender` object inside `server`:

```typescript
prerender: {
  routes: prerenderRoutes,
  crawlLinks: true,
  failOnError: true,
  autoSubfolderIndex: false,
},
```

**Do NOT change:** The `prerenderRoutes` array (routes stay extensionless -- Nitro applies `.html` naming itself). Do NOT remove `crawlLinks: true` (still handles non-doc links).

After changes, run `npm test` -- all tests MUST pass (GREEN).

Then run `npm run build` to compile TypeScript to dist/.
  </action>
  <verify>Run `npm test && npm run build`. All tests pass (GREEN). TypeScript compiles without errors. Verify: `grep -n "autoSubfolderIndex" src/site/app.config.ts` shows the new flag. `grep -c '.html' src/cli/build.ts` confirms `.html` appears in the three anchor locations.</verify>
  <done>All buildNavigationManifest tests pass with `.html` anchors. `app.config.ts` has `autoSubfolderIndex: false`. `npm run build` succeeds. dist/ updated.</done>
</task>

</tasks>

<verification>
1. `npm test` -- all tests pass (including updated anchor assertions)
2. `grep "autoSubfolderIndex" src/site/app.config.ts` -- shows `autoSubfolderIndex: false`
3. `grep "\.html" src/cli/build.ts` -- shows `.html` appended in doc anchor lines
4. `grep "\.html" src/cli/build.test.ts` -- shows `.html` in assertion strings
5. Schema section anchors in build.ts still use `#` prefix (no `.html`)
</verification>

<success_criteria>
- All 58+ existing tests pass with updated anchor assertions
- `autoSubfolderIndex: false` is set in app.config.ts prerender config
- Doc anchors in buildNavigationManifest output end with `.html`
- Schema anchors remain hash-based (unchanged)
- dist/ is compiled and up to date
</success_criteria>

<output>
After completion, create `.planning/phases/02-flat-html-output/02-01-SUMMARY.md`
</output>
