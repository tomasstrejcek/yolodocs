---
phase: 01-data-layer
plan: 02
type: tdd
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/cli/build.ts
  - src/cli/build.test.ts
autonomous: true
requirements:
  - DATA-01
  - DATA-03
  - NAV-03
  - NAV-06

must_haves:
  truths:
    - "A docs folder with `product/guides/filtering.md` produces a manifest with section 'Product', group 'Guides', and leaf item 'filtering'"
    - "Top-level folders (`product/`, `developer/`) produce separate NavigationSections with distinct IDs"
    - "Root-level pages (no folder) appear in a 'Documentation' section"
    - "Folder names like `developer-reference` become 'Developer Reference' in section and group labels"
    - "Groups within a section are sorted alphabetically by folder name; pages within groups sort by order then title"
  artifacts:
    - path: "src/cli/build.ts"
      provides: "3-level manifest grouping with multi-section support"
      contains: "sectionMap"
    - path: "src/cli/build.test.ts"
      provides: "Unit tests for manifest restructuring"
      min_lines: 30
  key_links:
    - from: "src/cli/build.ts"
      to: "src/schema/types.ts"
      via: "NavigationSection, NavigationItem imports"
      pattern: "import.*NavigationSection.*types"
    - from: "src/cli/build.ts"
      to: "src/markdown/loader.ts"
      via: "consumes DocsManifest.pages with H1-derived titles"
      pattern: "docsManifest\\.pages"
---

<objective>
Refactor `buildNavigationManifest` in build.ts to produce a 3-level navigation hierarchy with separate sections per top-level docs folder, collapsible groups for second-level folders, and correct title-casing for all folder labels.

Purpose: The manifest drives the sidebar navigation. Converting from a single flat "docs" section to multi-section, multi-group hierarchy enables the sidebar to render 3-level navigation (section > group > leaf) that matches the docs folder structure. This is the core data shape that Phase 3 (sidebar rendering) will consume.

Output: Updated `src/cli/build.ts` with refactored `buildNavigationManifest` function. Extended `src/cli/build.test.ts` with unit tests for the new grouping logic.
</objective>

<execution_context>
@/Users/tomasstrejcek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomasstrejcek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-layer/1-RESEARCH.md
@.planning/phases/01-data-layer/01-01-SUMMARY.md

@src/cli/build.ts
@src/cli/build.test.ts
@src/schema/types.ts
</context>

<feature>
  <name>3-level manifest grouping with multi-section support</name>
  <files>src/cli/build.ts, src/cli/build.test.ts</files>
  <behavior>
    **Slug Segment Parsing:**
    - `"getting-started"` -> section=null, group=null, leaf="getting-started" (root page)
    - `"product/billing"` -> section="product", group=null, leaf="billing" (2-segment, ungrouped in section)
    - `"product/guides/filtering"` -> section="product", group="guides", leaf="filtering" (3-level)
    - `"a/b/c/d"` -> section="a", group="b", leaf="c/d" (4+ segments flatten into leaf)

    **Section Creation (NAV-06):**
    - Root pages (no folder) -> section id: `"docs"`, title: `"Documentation"`
    - `product/*.md` -> section id: `"docs-product"`, title: `"Product"`
    - `developer/*.md` -> section id: `"docs-developer"`, title: `"Developer"`
    - Each top-level folder becomes its own NavigationSection

    **Group Creation (DATA-01):**
    - `product/guides/*.md` -> NavigationItem with id: `"docs-folder-product-guides"`, name: `"Guides"`, no anchor, children populated
    - `product/billing.md` -> ungrouped item directly under section items (no group wrapper)

    **Label Title-Casing (NAV-03):**
    - `"developer-reference"` -> `"Developer Reference"` (both sections and groups)
    - `"auth"` -> `"Auth"`
    - `"product"` -> `"Product"`
    Helper: `toTitleCase(slug: string): string` extracted as reusable function.

    **Sort Order:**
    - Docs sections appear before schema sections (existing behavior preserved)
    - Among docs sections: "Documentation" (root) first, then folder sections alphabetically
    - Within each section: ungrouped pages first (sorted by order then title), then groups alphabetically
    - Within each group: pages sorted by order then title

    **Manifest structure example:**
    Given docs: `getting-started.md`, `product/billing.md`, `product/guides/filtering.md`, `product/guides/auth.md`, `developer/api.md`

    Produces sections:
    ```
    [
      { id: "docs", title: "Documentation", items: [{ name: "Getting Started", anchor: "/docs/getting-started" }] },
      { id: "docs-developer", title: "Developer", items: [{ name: "Api", anchor: "/docs/developer/api" }] },
      { id: "docs-product", title: "Product", items: [
        { name: "Billing", anchor: "/docs/product/billing" },
        { name: "Guides", anchor: "", children: [
          { name: "Auth", anchor: "/docs/product/guides/auth" },
          { name: "Filtering", anchor: "/docs/product/guides/filtering" }
        ]}
      ]},
      // ... schema sections unchanged ...
    ]
    ```
  </behavior>
  <implementation>
    1. Extract `toTitleCase(s: string): string` helper at module level in build.ts:
       `s.replace(/-/g, " ").replace(/\b\w/g, c => c.toUpperCase())`
       This replaces the inline transform currently used for folder labels.

    2. Replace the docs section building block (lines ~251-314) in `buildNavigationManifest` with a 2-level grouping approach:

       a. Create a `sectionMap: Map<string, { ungrouped: pages[], groups: Map<string, pages[]> }>` and a `rootPages: pages[]` array.

       b. For each page in `docsManifest.pages`:
          - Split slug on `/`
          - 1 segment: push to `rootPages`
          - 2 segments: `parts[0]` is section, page is ungrouped within that section
          - 3+ segments: `parts[0]` is section, `parts[1]` is group, page goes into the group

       c. Emit sections in order:
          - If rootPages non-empty: emit `{ id: "docs", title: "Documentation", items: [...] }`
          - For each section in `sectionMap` sorted alphabetically by key:
            - Section id: `"docs-${sectionKey}"`
            - Section title: `toTitleCase(sectionKey)`
            - Items: ungrouped pages first (sorted by order/title), then groups alphabetically
            - Each group: `{ id: "docs-folder-${sectionKey}-${groupKey}", name: toTitleCase(groupKey), anchor: "", description: "", children: [...sorted pages...] }`

    3. The `sortPages` helper and schema section building (lines 317+) remain UNCHANGED.

    4. Preserve the existing `base` parameter usage for anchor construction: `${base}/docs/${p.slug}`.

    **Testing approach (TDD):**
    - To test `buildNavigationManifest` in isolation, extract it or create a testable wrapper. Since it's currently a private function in build.ts, the cleanest approach is to export it for testing. Add `export` to `function buildNavigationManifest(...)`.
    - Write tests in `src/cli/build.test.ts` within a new `describe("buildNavigationManifest")` block.
    - RED: Write tests for the grouping scenarios above
    - GREEN: Refactor buildNavigationManifest to pass
    - REFACTOR: Clean up

    **Important:**
    - Do NOT modify `NavigationItem` or `NavigationSection` interfaces in types.ts (they already support children).
    - Do NOT change schema section building logic (queries, mutations, etc.) â€” only the docs section building changes.
    - The `category` field on DocsPage is NOT used for grouping; slug path segments determine section/group membership.
    - For pages with a `category` set via frontmatter but also in a folder: the folder path takes precedence for navigation placement. The `category` field is ignored by the manifest builder.
  </implementation>
</feature>

<verification>
```bash
npm test
npm run build
```
All tests pass. TypeScript compiles without errors. The dist/ output is updated.
</verification>

<success_criteria>
- `buildNavigationManifest` produces separate NavigationSections for each top-level docs folder
- Root-level pages land in a "Documentation" section with id "docs"
- 3-level slug paths produce section > group > item nesting in the manifest
- Folder labels are title-cased (hyphen-separated words capitalized)
- Sort order: root section first, folder sections alphabetically, groups alphabetically within sections, pages by order/title within groups
- Schema sections (queries, mutations, etc.) remain unchanged
- All existing tests still pass
- `npm run build` succeeds and dist/ is updated
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-layer/01-02-SUMMARY.md`
</output>
