---
phase: 01-data-layer
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/markdown/loader.ts
  - src/markdown/loader.test.ts
autonomous: true
requirements:
  - DATA-02
  - DATA-04
  - TITL-01
  - TITL-02

must_haves:
  truths:
    - "A markdown file with `# My Title` as first H1 produces a DocsPage with title 'My Title'"
    - "A markdown file with frontmatter `title: Override` and H1 `# Body Title` produces title 'Override'"
    - "A markdown file with no frontmatter title and no H1 produces title from filename"
    - "Two slugs where one is a prefix of the other (e.g., `api` and `api/intro`) cause a build error with descriptive message"
    - "Slugs with double slashes or trailing slashes are normalized"
  artifacts:
    - path: "src/markdown/loader.ts"
      provides: "H1 extraction, title priority chain, slug normalization, collision detection"
      contains: "extractFirstH1"
    - path: "src/markdown/loader.test.ts"
      provides: "Unit tests for loader enhancements"
      min_lines: 80
  key_links:
    - from: "src/markdown/loader.ts"
      to: "src/schema/types.ts"
      via: "DocsPage interface import"
      pattern: "import.*DocsPage.*types"
---

<objective>
Enhance `scanDocsFolder` and `scanDir` in loader.ts to extract H1 titles from markdown, normalize slugs, and detect slug collisions at build time.

Purpose: The loader is the data source for all downstream navigation and page rendering. Correct title extraction (DATA-02, TITL-01, TITL-02) and slug safety (DATA-04) must be established before the manifest builder can produce a correct 3-level hierarchy.

Output: Updated `src/markdown/loader.ts` with H1 extraction, title priority chain, slug normalization, and collision detection. Comprehensive test file at `src/markdown/loader.test.ts`.
</objective>

<execution_context>
@/Users/tomasstrejcek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomasstrejcek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-layer/1-RESEARCH.md

@src/markdown/loader.ts
@src/schema/types.ts
</context>

<feature>
  <name>Loader enhancements: H1 extraction, slug normalization, collision detection</name>
  <files>src/markdown/loader.ts, src/markdown/loader.test.ts</files>
  <behavior>
    **H1 Extraction (DATA-02, TITL-01):**
    - `extractFirstH1("# Hello World")` -> `"Hello World"`
    - `extractFirstH1("## Not H1\n# Actual H1")` -> `"Actual H1"`
    - `extractFirstH1("No heading here")` -> `null`
    - `extractFirstH1("# \`createUser\` Mutation")` -> `` "`createUser` Mutation" `` (raw markdown, not rendered)
    - `extractFirstH1("# **Bold Title**")` -> `"**Bold Title**"` (raw markdown preserved)

    **Title Priority Chain (TITL-02):**
    - frontmatter.title set + H1 present -> uses frontmatter.title
    - frontmatter.title not set + H1 present -> uses H1
    - frontmatter.title not set + no H1 -> uses filename (basename without extension)

    **Slug Normalization:**
    - `"guides//auth"` -> `"guides/auth"` (collapse double slashes)
    - `"guides/auth/"` -> `"guides/auth"` (strip trailing slash)
    - `"/guides/auth"` -> `"guides/auth"` (strip leading slash)
    - `"guides\\auth"` -> `"guides/auth"` (Windows path sep, already handled)

    **Collision Detection (DATA-04):**
    - Slugs `["api", "api/intro"]` -> throws Error with message naming both slugs
    - Slugs `["dev/api", "dev/api/intro"]` -> throws Error
    - Slugs `["api", "auth"]` -> no error (no prefix collision)
    - Slugs `["dev/api", "dev/auth"]` -> no error
  </behavior>
  <implementation>
    1. Add `extractFirstH1(body: string): string | null` function using regex `/^#\s+(.+)/m`. The `/m` flag is critical so `^` matches any line start, not just string start.

    2. In `scanDir`, after `matter(content)` parse, call `extractFirstH1(body)` and change the title assignment to: `(frontmatter.title as string) || h1Title || path.basename(entry.name, path.extname(entry.name))`

    3. After slug computation, add normalization: `.replace(/\/+/g, "/").replace(/^\/|\/$/g, "")` (collapse double slashes, strip leading/trailing).

    4. Add `assertNoSlugCollisions(pages: DocsPage[]): void` function. Build a `Set` of all slugs, then for each slug check all prefix paths. If any prefix exists as a slug, throw with descriptive error naming both conflicting paths.

    5. Call `assertNoSlugCollisions(pages)` in `scanDocsFolder` before the sort step.

    6. Export `extractFirstH1` and `assertNoSlugCollisions` for testability.

    **Testing approach (TDD):**
    - Create `src/markdown/loader.test.ts`
    - RED: Write tests for extractFirstH1, title priority, slug normalization, collision detection, and full scanDocsFolder integration using temp directories
    - GREEN: Implement each feature to pass tests
    - REFACTOR: Clean up if needed

    **Important:** Do NOT modify the `DocsPage` interface in types.ts. The resolved `title` field is sufficient. Do NOT strip inline markdown from H1 captures (that's a Phase 3 concern). Do NOT change the existing sort order in `scanDocsFolder` (the manifest builder handles its own grouping regardless of input order).
  </implementation>
</feature>

<verification>
```bash
npm test
```
All tests pass including new loader tests. No TypeScript errors.
</verification>

<success_criteria>
- `extractFirstH1` correctly extracts first H1 from various markdown inputs
- Title priority chain: frontmatter > H1 > filename, verified by tests
- Slug normalization handles double slashes, trailing/leading slashes
- `assertNoSlugCollisions` throws descriptive error for prefix collisions
- `scanDocsFolder` integration test with real temp directory produces correct titles and detects collisions
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-layer/01-01-SUMMARY.md`
</output>
