---
phase: 02-flat-html-output
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/site/src/components/layout/Sidebar.tsx
  - src/site/src/routes/docs/[...path].tsx
  - src/site/src/components/welcome/WelcomePage.tsx
autonomous: true
requirements: [HOST-04]

must_haves:
  truths:
    - "Sidebar active state works when browser URL contains .html extension"
    - "Doc page lookup succeeds when params.path contains .html extension"
    - "WelcomePage Guides card links to a .html-suffixed doc URL"
    - "All three .html stripping points handle the no-extension case (SSR prerender) gracefully"
  artifacts:
    - path: "src/site/src/components/layout/Sidebar.tsx"
      provides: ".html stripping in active state derivation"
      contains: "endsWith(\".html\")"
    - path: "src/site/src/routes/docs/[...path].tsx"
      provides: ".html stripping in slug memo for page lookup"
      contains: "endsWith(\".html\")"
    - path: "src/site/src/components/welcome/WelcomePage.tsx"
      provides: ".html suffix on Guides card href"
      contains: ".html"
  key_links:
    - from: "src/site/src/components/layout/Sidebar.tsx"
      to: "manifest.json anchors"
      via: "derivedActiveId strips .html from pathname to match doc-{slug} item ids"
      pattern: "rawSlug\\.endsWith.*\\.html"
    - from: "src/site/src/routes/docs/[...path].tsx"
      to: "docs-manifest.json slugs"
      via: "slug memo strips .html from params.path to match page.slug"
      pattern: "raw\\.endsWith.*\\.html"
    - from: "src/site/src/components/welcome/WelcomePage.tsx"
      to: "flat HTML output files"
      via: "Guides card href includes .html matching actual file name"
      pattern: "\\.html"
---

<objective>
Update client-side components to handle `.html` extensions in browser URLs for correct active state, page lookup, and navigation links.

Purpose: When users access flat `.html` files directly on GCS/S3, the browser URL includes the `.html` extension. The sidebar active state, doc page route handler, and welcome page links must all handle this extension correctly.

Output: Three site template files updated with defensive `.html` handling that works both at SSR prerender time (no extension) and direct browser access (with extension).
</objective>

<execution_context>
@/Users/tomasstrejcek/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tomasstrejcek/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-flat-html-output/02-RESEARCH.md
@.planning/phases/02-flat-html-output/02-01-SUMMARY.md
@src/site/src/components/layout/Sidebar.tsx
@src/site/src/routes/docs/[...path].tsx
@src/site/src/components/welcome/WelcomePage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strip .html in Sidebar active state and doc route params</name>
  <files>src/site/src/components/layout/Sidebar.tsx, src/site/src/routes/docs/[...path].tsx</files>
  <action>
**Sidebar.tsx** -- In the `derivedActiveId` function (lines 36-49), update the doc pathname handling to strip `.html` before building the sidebar item id:

Current code (lines 41-43):
```typescript
if (pathname.startsWith(docsPrefix)) {
  const slug = pathname.slice(docsPrefix.length);
  return `doc-${slug}`;
}
```

Replace with:
```typescript
if (pathname.startsWith(docsPrefix)) {
  const rawSlug = pathname.slice(docsPrefix.length);
  const slug = rawSlug.endsWith(".html") ? rawSlug.slice(0, -5) : rawSlug;
  return `doc-${slug}`;
}
```

The `endsWith` guard ensures this works at both prerender time (pathname has no extension) and direct browser access on static hosting (pathname includes `.html`).

**[...path].tsx** -- In the DocsPage component (line 25), update the slug memo to strip `.html` from params.path:

Current code:
```typescript
const slug = createMemo(() => params.path || "");
```

Replace with:
```typescript
const slug = createMemo(() => {
  const raw = params.path || "";
  return raw.endsWith(".html") ? raw.slice(0, -5) : raw;
});
```

This ensures `page.slug === slug()` matches correctly regardless of whether the URL has `.html`.

**Important:** These files are inside `src/site/` which has its own tsconfig. Do NOT run the root `npm test` for these -- they are verified by the integration build in Task 2. The root `npm run build` (TypeScript compilation of `src/cli/`) does not cover site files.
  </action>
  <verify>Visually inspect both files for correct `.html` stripping logic. Verify both handle the no-extension case (SSR) by checking the `endsWith` guard exists. No automated test for site files -- verified by integration build in Task 2.</verify>
  <done>Sidebar.tsx strips `.html` from pathname before deriving active id. `[...path].tsx` strips `.html` from params.path before page lookup. Both handle the no-extension case gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Update WelcomePage Guides href and run integration build</name>
  <files>src/site/src/components/welcome/WelcomePage.tsx</files>
  <action>
**WelcomePage.tsx** -- Update the Guides CategoryCard href (line ~130) to append `.html`:

Current code:
```typescript
href={withBase(`/docs/${(docs.pages || [])[0]?.slug || ""}`)}
```

Replace with:
```typescript
href={withBase(`/docs/${(docs.pages || [])[0]?.slug || ""}.html`)}
```

This makes the welcome page Guides card link match the flat HTML file output.

**Then run the full integration test** to verify all Phase 2 changes work together end-to-end:

```bash
npm test && npm run build
rm -rf test-output && node dist/bin/yolodocs.js --schema schema.graphql --output test-output --title "Carl API" --docs-dir ./docs
```

After the integration build completes, verify flat HTML output:
1. Check that doc pages are flat files: `ls test-output/docs/` should show files like `getting-started.html`, `authentication.html` (not directories).
2. Check that NO `index.html` files exist inside doc subdirectories: `find test-output/docs -name index.html` should return nothing (except possibly `test-output/docs/index.html` if `/docs/` route is prerendered).
3. Verify `test-output/index.html` still exists (root page).
4. Verify `test-output/reference.html` exists (reference page).

**If the baseURL doubling concern from STATE.md manifests** (files in wrong directories), log the issue -- but this build uses empty base, so it should not trigger.

Clean up: `rm -rf test-output`

Commit dist/ alongside source changes per CLAUDE.md rules.
  </action>
  <verify>
1. `npm test` -- all tests pass
2. Integration build completes without errors
3. `ls test-output/docs/` shows flat `.html` files (e.g., `getting-started.html`)
4. `find test-output/docs -name index.html -type f` returns empty or only the docs landing page
5. `test-output/index.html` and `test-output/reference.html` exist
  </verify>
  <done>WelcomePage Guides href includes `.html`. Integration build produces flat HTML files in test-output/docs/. All doc pages are accessible as `slug.html` files. dist/ committed.</done>
</task>

</tasks>

<verification>
1. `npm test` -- all unit tests pass
2. Integration build (`node dist/bin/yolodocs.js ...`) succeeds
3. `ls test-output/docs/` shows flat `.html` files
4. No `index.html` inside doc subdirectories
5. `grep 'endsWith.*\.html' src/site/src/components/layout/Sidebar.tsx` -- shows .html stripping
6. `grep 'endsWith.*\.html' src/site/src/routes/docs/\\[...path\\].tsx` -- shows .html stripping
7. `grep '\.html' src/site/src/components/welcome/WelcomePage.tsx` -- shows .html in Guides href
</verification>

<success_criteria>
- Sidebar active state derivation strips `.html` from pathname before matching
- Doc route handler strips `.html` from params.path before page lookup
- WelcomePage Guides card href includes `.html` extension
- Integration build produces flat `.html` files (not `slug/index.html` directories)
- All unit tests pass, integration build succeeds
- dist/ committed with source changes
</success_criteria>

<output>
After completion, create `.planning/phases/02-flat-html-output/02-02-SUMMARY.md`
</output>
